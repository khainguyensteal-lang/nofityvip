getgenv().webhookHigh = "https://discord.com/api/webhooks/1438865076655493282/nPPLQSR-D43dQs8xNwv0kdhxDdjZXg-wo20BU-giDnYawo6SGWmL773ZwpicksQgGu-T" -- ‚â•10M
getgenv().webhookLow  = "https://discord.com/api/webhooks/1438097025634799616/X2is7ZIx0k0CiJh-tFo4dlCyBdpDPO5gMrMtFV8r22yIjm6prTsPeS6xHy3aqJkE9Dw6" -- 1M‚Äì7M
getgenv().HighMin = 10_000_000
getgenv().LowMin  = 1_000_000
getgenv().LowMax  = 10_000_000

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local lastColor = nil

local function getRandomColor()
    local color
    repeat
        local r = math.random(0, 255)
        local g = math.random(0, 255)
        local b = math.random(0, 255)
        color = bit32.lshift(r, 16) + bit32.lshift(g, 8) + b
    until color ~= lastColor
    lastColor = color
    return color
end

local function parseMoney(str)
    if not str or str == "" then return 0 end
    local num, suffix = str:match("([%d%.]+)%s*([KMBT]?)")
    num = tonumber(num)
    if not num then return 0 end
    local mult = ({ K=1e3, M=1e6, B=1e9, T=1e12 })[suffix:upper()] or 1
    return num * mult
end

local function getPlotOwner(plot)
    local sign = plot:FindFirstChild("PlotSign")
    if sign and sign:FindFirstChild("SurfaceGui") then
        local frame = sign.SurfaceGui:FindFirstChild("Frame")
        if frame and frame:FindFirstChild("TextLabel") then
            return tostring(frame.TextLabel.Text)
        end
    end
    return "Unknown Owner"
end

local function getObjectText(obj)
    if not obj then return nil end
    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        return obj.Text
    elseif obj:IsA("StringValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") then
        return obj.Value
    else
        return obj.Name
    end
end

local function scanPets(plot)
    local pets = {}
    local owner = getPlotOwner(plot)
    for _, obj in ipairs(plot:GetDescendants()) do
        local display, gen
        for _, child in ipairs(obj:GetDescendants()) do
            local n = child.Name:lower()
            if n:match("displayname") or n:match("display") then
                display = child
            elseif n:match("generation") or n:match("gen") then
                gen = child
            end
        end

        if display and gen then
            local nameText = getObjectText(display) or "???"
            local genText = getObjectText(gen) or "$???/s"
            local fullText = genText
            local value = parseMoney(genText)

            table.insert(pets, {
                name = nameText,
                gen = fullText,
                value = value,
                owner = owner
            })
        end
    end
    return pets
end

local function sendWebhook(pets, webhookURL, label)
    if #pets == 0 or not webhookURL then return end

    local owner = pets[1].owner or "Unknown Owner"
    local lines = {}
    for _, pet in ipairs(pets) do
        table.insert(lines, string.format("‚Ä¢ %s [%s]", pet.name, pet.gen))
    end

    local petBlock = "```md\n" .. table.concat(lines, "\n") .. "\n```"

    local joinLink = string.format(
        "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
        game.PlaceId, game.JobId
    )

    local tpScript = string.format(
        "game:GetService('TeleportService'):TeleportToPlaceInstance(%d, '%s', game.Players.LocalPlayer)",
        game.PlaceId, game.JobId
    )

    local embed = {
        username = "üõ∞Ô∏è ùêÉùêûùêßùêäùêöùê¢",
        embeds = {{
            title = "**" .. label .. " | ùêÉùêûùêßùêäùêöùê¢ ùêçùê®ùê≠ùê¢ùêüùê≤**",
            description = string.format(
           "üîç **ùêÖùê®ùêÆùêßùêù %d ùêèùêûùê≠ùê¨!** | üë§ **ùêéùê∞ùêßùêûùê´:** %s\n\n%s\n\nüë• **ùêèùê•ùêöùê≤ùêûùê´ùê¨**\n%d / %d\nüÜî **ùêâùê®ùêõùêàùêÉ**\n```text\n%s\n```\nüåê **ùêâùê®ùê¢ùêß ùêãùê¢ùêßùê§**\n[ùêÇùê•ùê¢ùêúùê§ ùê≠ùê® ùêâùê®ùê¢ùêß](%s)\nüìú **ùêìùêûùê•ùêûùê©ùê®ùê´ùê≠**\n```lua\n%s\n```",
           #pets, owner, petBlock, #Players:GetPlayers(), Players.MaxPlayers, game.JobId, joinLink, tpScript
    ),
            color = getRandomColor(), 
            footer = { text = "ùêåùêöùêùùêû ùêõùê≤ ùêäùê°ùêöùê¢ùêßùê†ùêÆùê≤ùêûùêß" },
            timestamp = DateTime.now():ToIsoDate()
        }}
    }

    local json = HttpService:JSONEncode(embed)
    local req = http_request or request or (syn and syn.request) or (http and http.request)
    if not req then return end

    pcall(function()
        req({
            Url = webhookURL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = json
        })
    end)
end

local sent = {}
task.spawn(function()
    while true do
        local playerCount = #Players:GetPlayers()
        if playerCount >= 4 then  
            for _, plot in pairs(Workspace.Plots:GetChildren()) do
                local allPets = scanPets(plot)
                local high, low = {}, {}

                for _, pet in ipairs(allPets) do
                    local id = pet.name .. "|" .. pet.gen .. "|" .. pet.owner
                    if not sent[id] then
                        if pet.value >= getgenv().HighMin then
                            table.insert(high, pet)
                            sent[id] = true
                        elseif pet.value >= getgenv().LowMin and pet.value <= getgenv().LowMax then
                            table.insert(low, pet)
                            sent[id] = true
                        end
                    end
                end

                if #high > 0 then
                    sendWebhook(high, getgenv().webhookHigh, "ùüèùüé-ùüèùüéùüéùê¶")
                end
                if #low > 0 then
                    sendWebhook(low, getgenv().webhookLow, "ùüè-ùüèùüéùê¶")
                end
            end
        end
        task.wait(1)
    end
end)

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local PlaceId = game.PlaceId

-----------------------------------------------------
-- üåü UI FULL M√ÄN H√åNH + COUNTDOWN
-----------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(1, 0, 1, 0)  -- FULL M√ÄN H√åNH CHU·∫®N
frame.BackgroundColor3 = Color3.new(1, 1, 1)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local countdownText = Instance.new("TextLabel")
countdownText.Size = UDim2.new(0, 200, 0, 100)
countdownText.Position = UDim2.new(0.5, -100, 0.5, -50)
countdownText.BackgroundTransparency = 1
countdownText.TextScaled = true
countdownText.Font = Enum.Font.SourceSansBold
countdownText.TextColor3 = Color3.new(0, 0, 0)
countdownText.Parent = frame

-- ‚è± 4s countdown
for i = 4, 1, -1 do
    countdownText.Text = i .. "s"
    task.wait(1)
end

-----------------------------------------------------
-- üîé T√åM SERVER KH√îNG FULL + KH√ÅC JOB ID
-----------------------------------------------------
local function findServer()
    local currentJobId = game.JobId
    local cursor = ""

    while true do
        local url = "https://games.roblox.com/v1/games/" .. PlaceId ..
            "/servers/Public?sortOrder=Asc&limit=100" ..
            (cursor ~= "" and "&cursor=" .. cursor or "")

        local data
        local success = pcall(function()
            data = HttpService:JSONDecode(game:HttpGet(url))
        end)

        if success and data and data.data then
            for _, server in ipairs(data.data) do
                if server.id ~= currentJobId and server.playing < server.maxPlayers then
                    return server.id
                end
            end

            if data.nextPageCursor then
                cursor = data.nextPageCursor
            else
                break
            end
        else
            break
        end
    end

    return nil
end

-----------------------------------------------------
-- üîÑ TELEPORT AN TO√ÄN + T·ª∞ TH·ª¨ L·∫†I
-----------------------------------------------------
local function safeTeleport()
    for tries = 1, 10 do
        local serverId = findServer()
        if serverId then
            print("‚û° Th·ª≠ teleport l·∫ßn", tries, "t·ªõi server:", serverId)

            local ok = pcall(function()
                TeleportService:TeleportToPlaceInstance(PlaceId, serverId, player)
            end)

            if ok then
                return
            end
        end
        task.wait(1)
    end

    warn("‚ùå Kh√¥ng t√¨m ƒë∆∞·ª£c server kh√°c sau 10 l·∫ßn th·ª≠.")
end

safeTeleport()
