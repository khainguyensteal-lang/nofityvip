-- âš™ï¸ CONFIG
getgenv().webhookHighlight = "https://discord.com/api/webhooks/1438943691220979763/b8zD7MlcF9phNI-Y8piQI4_FNLc-b3X7XQSJz9NzbHkkgafLUGUO-Enr_YeVu3zYc21h"
getgenv().webhookHigh      = "https://discord.com/api/webhooks/1438930956479107274/CCvp_89jS03b8wJOaXZ-zxOPdkINH-yfGQ3nF3AHyXrljsfSnIkUOwBzNc_tQDG4wF7V"
getgenv().webhookLow       = "https://discord.com/api/webhooks/1439470290819092573/ZReqW6GNn5ofT1nHPMvHSNuC1lQrOpCl0-tOkE6InpaogT2vqZ-Dgfp86wlofypPuQ8T"

getgenv().HighlightMin = 10_000_000 -- pets â‰¥10M
getgenv().HighMin      = 10_000_000 -- pets â‰¥10M
getgenv().LowMin       = 1_000_000
getgenv().LowMax       = 10_000_000

local HttpService = game:GetService("HttpService")
local Players     = game:GetService("Players")
local Workspace   = game:GetService("Workspace")

local function parseMoney(str)
    if not str or str == "" then return 0 end
    local num, suffix = str:match("([%d%.]+)%s*([KMBT]?)")
    num = tonumber(num)
    if not num then return 0 end
    local mult = ({ K=1e3, M=1e6, B=1e9, T=1e12 })[suffix:upper()] or 1
    return num * mult
end

-- Get object text
local function getObjectText(obj)
    if not obj then return nil end
    if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
        return obj.Text
    elseif obj:IsA("StringValue") or obj:IsA("IntValue") or obj:IsA("NumberValue") then
        return obj.Value
    else
        return obj.Name
    end
end

-- Scan pets in plot
local function scanPets(plot)
    local pets = {}
    for _, obj in ipairs(plot:GetDescendants()) do
        local display, gen
        for _, child in ipairs(obj:GetDescendants()) do
            local n = child.Name:lower()
            if n:match("displayname") or n:match("display") then
                display = child
            elseif n:match("generation") or n:match("gen") then
                gen = child
            end
        end

        if display and gen then
            local nameText = getObjectText(display) or "???"
            local genText  = getObjectText(gen) or "$???/s"
            local value    = parseMoney(genText)

            table.insert(pets, {
                name = nameText,
                gen  = genText,
                value = value
            })
        end
    end
    return pets
end

-- Send webhook chung (High vÃ  Low)
local function sendWebhook(pets, webhookURL, embedColor)
    if #pets == 0 or not webhookURL then return end

    local maxMoneyLen = 0
    for _, pet in ipairs(pets) do
        local len = #pet.gen
        if len > maxMoneyLen then maxMoneyLen = len end
    end

    local petLines = {}
    for _, pet in ipairs(pets) do
        local displayName = pet.name
        if #displayName > 17 then
            displayName = string.sub(displayName, 1, 17) .. "..."
        end
        table.insert(petLines, string.format("ðŸ·ï¸ %-20s %-"..maxMoneyLen.."s", displayName, pet.gen))
    end

    table.insert(petLines, string.format("ðŸ‘¥ Players %d/%d", #Players:GetPlayers(), Players.MaxPlayers))

    local petText = "```text\n" .. table.concat(petLines, "\n") .. "\n```"

    local joinLink = string.format(
        "https://chillihub1.github.io/chillihub-joiner/?placeId=%d&gameInstanceId=%s",
        game.PlaceId, game.JobId
    )

    local tpScript = string.format(
        "game:GetService('TeleportService'):TeleportToPlaceInstance(%d, '%s', game.Players.LocalPlayer)",
        game.PlaceId, game.JobId
    )

    local embed = {
        username = "ðƒðžð§ðŠðšð¢",
        embeds = {{
            title = "ðð«ðšð¢ð§ð«ð¨ð­ ðð¨ð­ð¢ðŸð² | ðƒðžð§ð¤ðšð¢",
            description = string.format(
                "%s\nðŸ†” ð‰ð¨ð›ðˆðƒ `%s`\nðŸŒ ð‰ð¨ð¢ð§ ð‹ð¢ð§ð¤ [Click to Join](%s)\nðŸ“œ ð“ðžð¥ðžð©ð¨ð«ð­\n```lua\n%s\n```",
                petText, game.JobId, joinLink, tpScript
            ),
            color = embedColor,
            footer = { text = "ðŒðšððž ð›ð² ðŠð¡ðšð¢ð§ð ð®ð²ðžð§" },
            timestamp = DateTime.now():ToIsoDate()
        }}
    }

    local json = HttpService:JSONEncode(embed)
    local req = http_request or request or (syn and syn.request) or (http and http.request)
    if not req then return end

    pcall(function()
        req({
            Url = webhookURL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = json
        })
    end)
end

-- Send highlight (mÃ u cam)
local function sendHighlightWebhook(pets, webhookURL)
    if #pets == 0 or not webhookURL then return end

    local petLines = {}
    for _, pet in ipairs(pets) do
        local displayName = pet.name -- giá»¯ nguyÃªn, khÃ´ng cáº¯t

        -- gen náº±m trong []
        table.insert(petLines, "ðŸ·ï¸ " .. displayName .. " [" .. pet.gen .. "]")
    end

    local petText = "```text\n" .. table.concat(petLines, "\n") .. "\n```"

    local embed = {
        username = "ð‡ð¢ð ð¡ð¥ð¢ð ð¡ð­ð¬",
        embeds = { {
            title = "ðð«ðšð¢ð§ð«ð¨ð­ ðð¨ð­ð¢ðŸð² | ðƒðžð§ð¤ðšð¢",
            description = petText,
            color = 0xFFAA00,
            footer = { text = "ðŒðšððž ð›ð² ðŠð¡ðšð¢ð§ð ð®ð²ðžð§" },
            timestamp = DateTime.now():ToIsoDate()
        } }
    }

    local json = HttpService:JSONEncode(embed)
    local req = http_request or request or (syn and syn.request) or (http and http.request)
    if not req then return end

    pcall(function()
        req({
            Url = webhookURL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = json
        })
    end)
end


-- ðŸ” Main loop vá»›i sent riÃªng cho tá»«ng loáº¡i Ä‘á»ƒ High vÃ  Highlight cÃ¹ng gá»­i
local sentHighlight = {}
local sentHigh = {}
local sentLow = {}

task.spawn(function()
    while true do
        for _, plot in pairs(Workspace.Plots:GetChildren()) do
            local allPets = scanPets(plot)
            local highlight, high, low = {}, {}, {}

            for _, pet in ipairs(allPets) do
                local id = pet.name .. "|" .. pet.gen

                -- Highlight (â‰¥10M) - mÃ u cam
                if pet.value >= getgenv().HighlightMin and not sentHighlight[id] then
                    table.insert(highlight, pet)
                    sentHighlight[id] = true
                end

                -- High (â‰¥10M) - mÃ u Ä‘á»
                if pet.value >= getgenv().HighMin and not sentHigh[id] then
                    table.insert(high, pet)
                    sentHigh[id] = true
                end

                -- Low (1Mâ€“10M) - mÃ u xanh
                if pet.value >= getgenv().LowMin and pet.value <= getgenv().LowMax and not sentLow[id] then
                    table.insert(low, pet)
                    sentLow[id] = true
                end
            end

            -- Gá»­i webhook
            if #highlight > 0 then
                sendHighlightWebhook(highlight, getgenv().webhookHighlight)
            end
            if #high > 0 then
                sendWebhook(high, getgenv().webhookHigh, 0xFF0000)
            end
            if #low > 0 then
                sendWebhook(low, getgenv().webhookLow, 0x00AAFF)
            end
        end
        task.wait(1)
    end
end)
